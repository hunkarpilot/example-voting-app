name: Build and Deploy to EKS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: eu-west-2
  EKS_CLUSTER_NAME: talent-904976121950
  ECR_REGISTRY: 130575395405.dkr.ecr.eu-west-2.amazonaws.com
  CANDIDATE_ID: "904976121950"
  SANDBOX_ROLE_ARN: "arn:aws:iam::130575395405:role/talent_role"

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [vote, result, worker]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.SANDBOX_ROLE_ARN }}
          role-skip-session-tagging: true

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image
        working-directory: ./${{ matrix.app }}
        run: |
          IMAGE_TAG="${GITHUB_SHA::8}"
          REPO_NAME="bion-talent-${CANDIDATE_ID}"
          if [ "${{ matrix.app }}" == "vote" ]; then REPO_NAME="${REPO_NAME}-voting-app"; fi
          if [ "${{ matrix.app }}" == "result" ]; then REPO_NAME="${REPO_NAME}-result-app"; fi
          if [ "${{ matrix.app }}" == "worker" ]; then REPO_NAME="${REPO_NAME}-worker"; fi
          
          FULL_IMAGE="${ECR_REGISTRY}/${REPO_NAME}:${IMAGE_TAG}"
          
          docker build -t $FULL_IMAGE .
          docker push $FULL_IMAGE
          
          echo "âœ… Pushed ${{ matrix.app }} image: ${FULL_IMAGE}"

      - name: Scan image
        uses: anchore/scan-action@v6
        with:
          image: "${{ env.FULL_IMAGE }}"      
          output-file: "${{ env.FULL_IMAGE }}.json"
          output-format: "json"

      # - name: Scan status (failed)
      #   uses: shallwefootball/s3-upload-action@master
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ env.AWS_REGION }}
      #     bucket: ${{ env.BUCKET_NAME }}
      #     file: ${{ env.FULL_IMAGE }}.json


          
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.SANDBOX_ROLE_ARN }}
          role-skip-session-tagging: true

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Deploy to EKS
        run: |
          IMAGE_TAG="${GITHUB_SHA::8}"
          
          # Replace IMAGE_TAG in manifest files
          sed -i "s/IMAGE_TAG/${IMAGE_TAG}/g" k8s-specifications/vote-deployment.yaml
          sed -i "s/IMAGE_TAG/${IMAGE_TAG}/g" k8s-specifications/result-deployment.yaml
          sed -i "s/IMAGE_TAG/${IMAGE_TAG}/g" k8s-specifications/worker-deployment.yaml
          
          # Apply manifests
          kubectl apply -f k8s-specifications/
          
          # Wait for rollout
          kubectl rollout status deployment/vote -n default --timeout=300s
          kubectl rollout status deployment/result -n default --timeout=300s
          kubectl rollout status deployment/worker -n default --timeout=300s
          kubectl rollout status deployment/db -n default --timeout=300s
          kubectl rollout status deployment/redis -n default --timeout=300s

      - name: Get LoadBalancer URLs
        run: |
          echo "ðŸ”— Getting LoadBalancer DNS names..."
          echo ""
          echo "================================================"
          echo "ðŸ“Š APPLICATION ACCESS ENDPOINTS"
          echo "================================================"
          echo ""
          
          # Check services
          kubectl get svc vote result
          
          echo ""
          echo "NOTE: If EXTERNAL-IP is <pending>, please check back in a few minutes using 'kubectl get svc'"
